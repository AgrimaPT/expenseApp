{% extends "base.html" %}
{% block content %}
<div class="container mt-3 mt-md-4">
    <div class="card shadow-sm">
        <div class="card-header bg-white">
            <h2 class="mb-0">
                <i class="fas fa-credit-card me-2 text-primary"></i>
                Add Online Payment
            </h2>
        </div>
        
        <div class="card-body">
            <form method="post" enctype="multipart/form-data" id="payment-form" class="needs-validation" novalidate>
                {% csrf_token %}

                <div class="row mb-4">
                    <div class="col-md-4 mb-3 mb-md-0">
                        <label for="date" class="form-label">Date</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                            <input type="date" name="date" class="form-control" value="{{ today_date }}" required>
                        </div>
                    </div>
                </div>

                <div class="border rounded p-3 mb-4 bg-light">
                    <h5 class="mb-3">
                        <i class="fas fa-plus-circle me-2 text-success"></i>
                        Add Payment Item
                    </h5>
                    
                    <div class="row g-2">
                        <div class="col-12 col-md-3">
                            <select id="item-category" class="form-select" required>
                                <option value="" selected disabled>Select Category</option>
                                {% for cat in categories %}
                                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">Please select a category</div>
                        </div>
                        <div class="col-6 col-md-2">
                            <input type="number" id="item-qty" class="form-control" placeholder="Qty" min="1" required>
                            <div class="invalid-feedback">Enter valid quantity</div>
                        </div>
                        <div class="col-6 col-md-2">
                            <input type="number" id="item-price" class="form-control" placeholder="Price" step="0.01" min="0" required>
                            <div class="invalid-feedback">Enter valid price</div>
                        </div>
                        <div class="col-12 col-md-3">
                            <input type="text" id="item-bill-number" class="form-control" placeholder="Bill Number">
                        </div>
                        <div class="col-12 col-md-2">
                            <label for="item-bill-image" class="d-block d-md-none form-label">Bill Image</label>
                            <input type="file" id="item-bill-image" class="form-control" accept="image/*">
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-end mt-3">
                        <button type="button" class="btn btn-success" onclick="addPaymentItem()">
                            <i class="fas fa-plus me-1"></i> Add Item
                        </button>
                    </div>
                </div>

                <div class="table-responsive mb-4">
                    <table class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th width="5%">#</th>
                                <th>Category</th>
                                <th width="8%">Qty</th>
                                <th width="10%">Price</th>
                                <th width="15%">Bill#</th>
                                <th width="15%">Image</th>
                                <th width="12%">Amount</th>
                                <th width="8%">Action</th>
                            </tr>
                        </thead>
                        <tbody id="payment-items">
                            <tr id="empty-row" class="text-center text-muted">
                                <td colspan="8">No items added yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <input type="hidden" name="items_json" id="items-json">
                <div id="file-inputs"></div>

                <div class="d-flex justify-content-between align-items-center mb-4 p-3 bg-light rounded">
                    <div>
                        <span class="fw-bold">Total Items: </span>
                        <span id="total-items" class="badge bg-primary">0</span>
                    </div>
                    <div class="text-end">
                        <span class="fw-bold fs-5">Total Amount: </span>
                        <span id="total-amount" class="fw-bold fs-5 text-success">₹0.00</span>
                    </div>
                </div>

                <div class="d-flex justify-content-end gap-2">
                    <button type="reset" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-1"></i> Reset
                    </button>
                    <button type="submit" class="btn btn-primary" id="submit-btn" disabled>
                        <i class="fas fa-save me-1"></i> Save Payment
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    let items = [];

    function addPaymentItem() {
        const form = document.getElementById('payment-form');
        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            return;
        }

        const catSelect = document.getElementById('item-category');
        const catId = catSelect.value;
        const catName = catSelect.options[catSelect.selectedIndex].text;
        const qty = parseFloat(document.getElementById('item-qty').value);
        const price = parseFloat(document.getElementById('item-price').value);
        const billNumber = document.getElementById('item-bill-number').value;
        const billImage = document.getElementById('item-bill-image').files[0];

        const index = items.length;
        items.push({ 
            catId, 
            catName, 
            qty, 
            price, 
            amount: qty * price, 
            billNumber 
        });

        // Remove empty row if it exists
        const emptyRow = document.getElementById('empty-row');
        if (emptyRow) emptyRow.remove();

        const tbody = document.getElementById('payment-items');
        const row = tbody.insertRow();
        row.className = 'align-middle';

        row.innerHTML = `
            <td>${index + 1}</td>
            <td>${catName}</td>
            <td>${qty}</td>
            <td>₹${price.toFixed(2)}</td>
            <td>${billNumber || '-'}</td>
            <td>${billImage ? '<i class="fas fa-file-image text-success"></i> ' + billImage.name : '-'}</td>
            <td class="fw-bold">₹${(qty * price).toFixed(2)}</td>
            <td>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeItem(${index})">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </td>
        `;

        // Handle file upload
        if (billImage) {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.name = `billImage_${index}`;
            fileInput.style.display = 'none';
            
            // Create a new DataTransfer to set files
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(billImage);
            fileInput.files = dataTransfer.files;
            
            document.getElementById('file-inputs').appendChild(fileInput);
        }

        updateJSON();
        resetInputs();
        document.getElementById('submit-btn').disabled = items.length === 0;
    }

    function updateJSON() {
        document.getElementById('items-json').value = JSON.stringify(items);
        const total = items.reduce((sum, item) => sum + item.amount, 0);
        document.getElementById('total-amount').innerText = `₹${total.toFixed(2)}`;
        document.getElementById('total-items').innerText = items.length;
    }

    function resetInputs() {
        document.getElementById('item-category').value = '';
        document.getElementById('item-qty').value = '';
        document.getElementById('item-price').value = '';
        document.getElementById('item-bill-number').value = '';
        document.getElementById('item-bill-image').value = '';
        document.getElementById('payment-form').classList.remove('was-validated');
    }

    function removeItem(index) {
        items.splice(index, 1);
        renderItems();
        document.getElementById('submit-btn').disabled = items.length === 0;
    }

    function renderItems() {
        const tbody = document.getElementById('payment-items');
        tbody.innerHTML = '';
        
        if (items.length === 0) {
            tbody.innerHTML = `
                <tr id="empty-row" class="text-center text-muted">
                    <td colspan="8">No items added yet</td>
                </tr>
            `;
            return;
        }

        items.forEach((item, index) => {
            const row = tbody.insertRow();
            row.className = 'align-middle';
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${item.catName}</td>
                <td>${item.qty}</td>
                <td>₹${item.price.toFixed(2)}</td>
                <td>${item.billNumber || '-'}</td>
                <td>
                    ${document.querySelector(`input[name="billImage_${index}"]`) ? 
                      '<i class="fas fa-file-image text-success"></i> ' + 
                      document.querySelector(`input[name="billImage_${index}"]`).files[0].name : 
                      '-'}
                </td>
                <td class="fw-bold">₹${item.amount.toFixed(2)}</td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeItem(${index})">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            `;
        });
        
        updateJSON();
    }
</script>

<style>
    .card {
        border-radius: 0.5rem;
    }
    
    .card-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid rgba(0,0,0,.125);
    }
    
    .table th {
        white-space: nowrap;
    }
    
    @media (max-width: 768px) {
        .card-header {
            text-align: center;
        }
        
        .btn {
            width: 100%;
            margin-bottom: 0.5rem;
        }
        
        .d-flex.justify-content-end {
            flex-direction: column;
        }
    }

</style>
{% endblock %}